{
	"_id": "SN8lV6qG0nwuJjgp",
	"_key": "!macros!SN8lV6qG0nwuJjgp",
	"author": "Wh2LMImbzawNAQ7v",
	"command": "//TODO:\n//check wildshape charges and deduct one on each wildshape activation\n\n// Check if a token is selected\nif (canvas.tokens.controlled.length === 0) {\n  ui.notifications.warn(\"Please select a token.\");\n  return;\n}\n\n// Get the selected actor\nlet actor = canvas.tokens.controlled[0].actor;\n\n// Find all wildshape buffs on the actor\nlet wildshapes = actor.items.filter(i => i.type === \"buff\" && i.system?.buffType === \"shapechange\" && i.system?.shapechange.type === \"wildshape\");\n\n// If no wildshape buffs are found, notify the user\nif (wildshapes.length === 0) {\n  ui.notifications.warn(\"No wildshape buffs found.\");\n  return;\n}\n\n// Check if there is an active wildshape\nlet activeWildshape = wildshapes.find(buff => buff.system?.active === true);\n\nif (activeWildshape) {\n  // Deactivate the currently active wildshape and exit\n  await activeWildshape.update({ \"system.active\": false });\n  ui.notifications.info(`${activeWildshape.name} wildshape deactivated.`);\n  return;\n}\n\n// get items to unmeld\nlet wildItems = actor.items.filter(i => i.system?.customTag === \"wild\");\n\n// Create a button list for all wildshape buffs\nlet buttons = wildshapes.map(buff => {\n  return {\n    label: buff.name,\n    icon: `<img src=\"${buff.img}\" width=\"50\" height=\"50\" style=\"float: left; margin-right: 10px;\">`,\n    callback: async () => {\n      // Activate the selected wildshape buff\n      await buff.update({ \"system.active\": true });\n      ui.notifications.info(`${buff.name} wildshape activated.`);\n\n      // Unmeld items (set `melded` to false)\n      for (let item of wildItems) {\n        let actorItem = actor.items.find(i => i.name === item.name);\n        if (actorItem) {\n          await actorItem.update({ \"system.melded\": false });\n          ui.notifications.info(`${item.name} unmelded for ${actor.name}.`);\n        }\n      }\n    }\n  };\n});\n\n// Create the dialog content and buttons layout\nlet dialogContent = `\n  <style>\n    .wildshape-button {\n      display: flex;\n      align-items: center;\n      justify-content: flex-start;\n      height: 60px;\n      margin: 5px 0;\n      padding: 5px;\n      border: 1px solid #ccc;\n      border-radius: 5px;\n      cursor: pointer;\n      width: 100%;\n      box-sizing: border-box;\n    }\n    .wildshape-button img {\n      flex-shrink: 0;\n    }\n    .wildshape-button .wildshape-label {\n      flex-grow: 1;\n      text-align: left;\n      white-space: normal;\n      word-wrap: break-word;\n      line-height: 1.2;\n    }\n  </style>\n  <div>\n    ${buttons.map(b => `\n      <div class=\"wildshape-button\" data-label=\"${b.label}\">\n        ${b.icon}\n        <div class=\"wildshape-label\">${b.label}</div>\n      </div>\n    `).join(\"\")}\n  </div>\n`;\n\n// Display the dialog with buttons for each wildshape\nlet dialog = new Dialog({\n  title: \"Select Wildshape\",\n  content: dialogContent,\n  buttons: {},\n  render: html => {\n    html.find(\".wildshape-button\").click(async function() {\n      let label = $(this).data(\"label\");\n      let selectedBuff = wildshapes.find(b => b.name === label);\n      if (selectedBuff) {\n        await selectedBuff.update({ \"system.active\": true });\n        ui.notifications.info(`${selectedBuff.name} wildshape activated.`);\n\n        // Unmeld items (set `melded` to false)\n        for (let item of wildItems) {\n          let actorItem = actor.items.find(i => i.name === item.name);\n          if (actorItem) {\n            await actorItem.update({ \"system.melded\": false });\n            ui.notifications.info(`${item.name} unmelded for ${actor.name}.`);\n          }\n        }\n      }\n      dialog.close();\n    });\n  },\n  default: \"cancel\",\n  close: () => {}\n}).render(true);",
	"folder": "K9haakWUiqq1NlYi",
	"img": "systems/D35E/icons/classfeatures/wild-shape.png",
	"name": "Wildshape",
	"scope": "global",
	"type": "script"
}
