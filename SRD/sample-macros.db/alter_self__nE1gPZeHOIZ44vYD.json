{
	"_id": "nE1gPZeHOIZ44vYD",
	"_key": "!macros!nE1gPZeHOIZ44vYD",
	"author": "Wh2LMImbzawNAQ7v",
	"command": "// Check if a token is selected\nif (canvas.tokens.controlled.length === 0) {\n  ui.notifications.warn(\"Please select a token.\");\n  return;\n}\n\n// Get the selected actor\nlet actor = canvas.tokens.controlled[0].actor;\n\n// Find all alterself buffs on the actor\nlet alterselfs = actor.items.filter(i => i.type === \"buff\" && i.system?.buffType === \"shapechange\" && i.system?.shapechange.type === \"alter-self\");\n\n// If no alterselfs buffs are found, notify the user\nif (alterselfs.length === 0) {\n  ui.notifications.warn(\"No alterselfs buffs found.\");\n  return;\n}\n\n// Check if there is an active alterself\nlet activeAlterSelf = alterselfs.find(buff => buff.system?.active === true);\n\nif (activeAlterSelf) {\n  // Deactivate the currently active alterself and exit\n  await activeAlterSelf.update({ \"system.active\": false });\n  ui.notifications.info(`${activeAlterSelf.name} alterself deactivated.`);\n  return;\n}\n\n// get items to unmeld\nlet noalterselfitems = actor.items.filter(i => i.system?.customTag === \"nopoly\");\n\n// Create a button list for all alterself buffs\nlet buttons = alterselfs.map(buff => {\n  return {\n    label: buff.name,\n    icon: `<img src=\"${buff.img}\" width=\"50\" height=\"50\" style=\"float: left; margin-right: 10px;\">`,\n    callback: async () => {\n      // Activate the selected alterself buff\n      await buff.update({ \"system.active\": true });\n      ui.notifications.info(`${buff.name} alterself activated.`);\n\n      // Unmeld items (set `melded` to false)\n      for (let item of noalterselfitems) {\n        let actorItem = actor.items.find(i => i.name === item.name);\n        if (actorItem) {\n          await actorItem.update({ \"system.melded\": false });\n          ui.notifications.info(`${item.name} unmelded for ${actor.name}.`);\n        }\n      }\n    }\n  };\n});\n\n// Create the dialog content and buttons layout\nlet dialogContent = `\n  <style>\n    .alterself-button {\n      display: flex;\n      align-items: center;\n      justify-content: flex-start;\n      height: 60px;\n      margin: 5px 0;\n      padding: 5px;\n      border: 1px solid #ccc;\n      border-radius: 5px;\n      cursor: pointer;\n      width: 100%;\n      box-sizing: border-box;\n    }\n    .alterself-button img {\n      flex-shrink: 0;\n    }\n    .alterself-button .alterself-label {\n      flex-grow: 1;\n      text-align: left;\n      white-space: normal;\n      word-wrap: break-word;\n      line-height: 1.2;\n    }\n  </style>\n  <div>\n    ${buttons.map(b => `\n      <div class=\"alterself-button\" data-label=\"${b.label}\">\n        ${b.icon}\n        <div class=\"alterself-label\">${b.label}</div>\n      </div>\n    `).join(\"\")}\n  </div>\n`;\n\n// Display the dialog with buttons for each alterself\nlet dialog = new Dialog({\n  title: \"Select Alter Self\",\n  content: dialogContent,\n  buttons: {},\n  render: html => {\n    html.find(\".alterself-button\").click(async function() {\n      let label = $(this).data(\"label\");\n      let selectedBuff = alterselfs.find(b => b.name === label);\n      if (selectedBuff) {\n        await selectedBuff.update({ \"system.active\": true });\n        ui.notifications.info(`${selectedBuff.name} alterself activated.`);\n\n        // Unmeld items (set `melded` to false)\n        for (let item of noalterselfitems) {\n          let actorItem = actor.items.find(i => i.name === item.name);\n          if (actorItem) {\n            await actorItem.update({ \"system.melded\": false });\n            ui.notifications.info(`${item.name} unmelded for ${actor.name}.`);\n          }\n        }\n      }\n      dialog.close();\n    });\n  },\n  default: \"cancel\",\n  close: () => {}\n}).render(true);",
	"folder": "K9haakWUiqq1NlYi",
	"img": "https://abrpgfoundrybucket.s3.eu-west-2.amazonaws.com/Generic%20Assets/icons/spells/named-spells/alter-self.png",
	"name": "Alter Self",
	"scope": "global",
	"type": "script"
}
