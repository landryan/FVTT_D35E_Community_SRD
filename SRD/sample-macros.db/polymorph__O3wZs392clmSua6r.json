{
	"_id": "O3wZs392clmSua6r",
	"_key": "!macros!O3wZs392clmSua6r",
	"author": "Wh2LMImbzawNAQ7v",
	"command": "// Check if a token is selected\nif (canvas.tokens.controlled.length === 0) {\n  ui.notifications.warn(\"Please select a token.\");\n  return;\n}\n\n// Get the selected actor\nlet actor = canvas.tokens.controlled[0].actor;\n\n// Find all polymorph buffs on the actor\nlet polymorphs = actor.items.filter(i => i.type === \"buff\" && i.system?.buffType === \"shapechange\" && i.system?.shapechange.type === \"polymorph\");\n\n// If no polymorphs buffs are found, notify the user\nif (polymorphs.length === 0) {\n  ui.notifications.warn(\"No polymorphs buffs found.\");\n  return;\n}\n\n// Check if there is an active polymorph\nlet activePolymorph = polymorphs.find(buff => buff.system?.active === true);\n\nif (activePolymorph) {\n  // Deactivate the currently active polymorph and exit\n  await activePolymorph.update({ \"system.active\": false });\n  ui.notifications.info(`${activePolymorph.name} polymorph deactivated.`);\n  return;\n}\n\n// get items to unmeld\nlet nopolyitems = actor.items.filter(i => i.system?.customTag === \"nopoly\");\n\n// Create a button list for all polymorph buffs\nlet buttons = polymorphs.map(buff => {\n  return {\n    label: buff.name,\n    icon: `<img src=\"${buff.img}\" width=\"50\" height=\"50\" style=\"float: left; margin-right: 10px;\">`,\n    callback: async () => {\n      // Activate the selected polymorph buff\n      await buff.update({ \"system.active\": true });\n      ui.notifications.info(`${buff.name} polymorph activated.`);\n\n      // Unmeld items (set `melded` to false)\n      for (let item of nopolyitems) {\n        let actorItem = actor.items.find(i => i.name === item.name);\n        if (actorItem) {\n          await actorItem.update({ \"system.melded\": false });\n          ui.notifications.info(`${item.name} unmelded for ${actor.name}.`);\n        }\n      }\n    }\n  };\n});\n\n// Create the dialog content and buttons layout\nlet dialogContent = `\n  <style>\n    .polymorph-button {\n      display: flex;\n      align-items: center;\n      justify-content: flex-start;\n      height: 60px;\n      margin: 5px 0;\n      padding: 5px;\n      border: 1px solid #ccc;\n      border-radius: 5px;\n      cursor: pointer;\n      width: 100%;\n      box-sizing: border-box;\n    }\n    .polymorph-button img {\n      flex-shrink: 0;\n    }\n    .polymorph-button .polymorph-label {\n      flex-grow: 1;\n      text-align: left;\n      white-space: normal;\n      word-wrap: break-word;\n      line-height: 1.2;\n    }\n  </style>\n  <div>\n    ${buttons.map(b => `\n      <div class=\"polymorph-button\" data-label=\"${b.label}\">\n        ${b.icon}\n        <div class=\"polymorph-label\">${b.label}</div>\n      </div>\n    `).join(\"\")}\n  </div>\n`;\n\n// Display the dialog with buttons for each polymorph\nlet dialog = new Dialog({\n  title: \"Select Polymorph\",\n  content: dialogContent,\n  buttons: {},\n  render: html => {\n    html.find(\".polymorph-button\").click(async function() {\n      let label = $(this).data(\"label\");\n      let selectedBuff = polymorphs.find(b => b.name === label);\n      if (selectedBuff) {\n        await selectedBuff.update({ \"system.active\": true });\n        ui.notifications.info(`${selectedBuff.name} polymorph activated.`);\n\n        // Unmeld items (set `melded` to false)\n        for (let item of nopolyitems) {\n          let actorItem = actor.items.find(i => i.name === item.name);\n          if (actorItem) {\n            await actorItem.update({ \"system.melded\": false });\n            ui.notifications.info(`${item.name} unmelded for ${actor.name}.`);\n          }\n        }\n      }\n      dialog.close();\n    });\n  },\n  default: \"cancel\",\n  close: () => {}\n}).render(true);",
	"folder": "K9haakWUiqq1NlYi",
	"img": "https://abrpgfoundrybucket.s3.eu-west-2.amazonaws.com/Generic%20Assets/icons/spells/named-spells/baleful-polymorph.png",
	"name": "Polymorph",
	"scope": "global",
	"type": "script"
}
